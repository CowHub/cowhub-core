machine:
  environment:
    S3_BUCKET: cowhub-lambda-functions
    S3_KEY_REGISTER: cowhub-image-register/$CIRCLE_BUILD_NUM-$CIRCLE_SHA1
  services:
    - docker

dependencies:
  override:
    - pip install awscli

test:
  override:
    - mkdir -p package-lib
    - |
      docker login -e $DOCKER_EMAIL -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
      docker run -itd -v $PWD/package-lib:/package-lib cowhub/cowhub-core \
                 /bin/bash -c 'cd /package-lib && tar -xvf /stack.tgz'
    - ./make_and_verify_package.sh cowhub-image-register

deployment:
  production:
    branch: master
    commands:
      - |
        cp -r cowhub-image-register.zip $CIRCLE_ARTIFACTS/
        aws s3 cp cowhub-image-register.zip s3://$S3_BUCKET/$S3_KEY_REGISTER
        aws lambda update-function-code \
            --region eu-west-1 \
            --function-name cowhub-image-register \
            --s3-bucket $S3_BUCKET \
            --s3-key $S3_KEY_REGISTER
