machine:
  services:
    - docker

dependencies:
  override:
    - pip install awscli

test:
  override:
    - mkdir -p package-lib
    - docker login -e $DOCKER_EMAIL -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
    - |
      docker run -itd -v $PWD/package-lib:/package-lib cowhub/cowhub-core \
                 /bin/bash -c 'cd /package-lib && tar -xvf /stack.tgz'
    - mkdir -p publish
    - cp -r lib/* publish/
    - cp -r package/* publish/
    - cp -r package-lib/* publish/
    - cd publish && zip -r cowhub-image-register.zip .

deployment:
  production:
    branch: master
    commands:
      - cp -r publish/cowhub-image-register.zip $CIRCLE_ARTIFACTS/
      - |
        aws lambda update-function-code \
            --region eu-west-1 \
            --function-name cowhub-image-register \
            --zip-file fileb://$PWD/publish/cowhub-image-register.zip
